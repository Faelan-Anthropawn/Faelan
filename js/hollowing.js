import { coordsXZY, indexXZY } from './schematic-reader.js';

const NON_SOLID_BLOCKS = new Set([ 
  "minecraft:air", "minecraft:water", "minecraft:flowing_water", "minecraft:lava", "minecraft:flowing_lava", "minecraft:glass", "minecraft:tinted_glass", "minecraft:white_stained_glass", "minecraft:orange_stained_glass", "minecraft:magenta_stained_glass", "minecraft:light_blue_stained_glass", "minecraft:yellow_stained_glass", "minecraft:lime_stained_glass", "minecraft:pink_stained_glass", "minecraft:gray_stained_glass", "minecraft:light_gray_stained_glass", "minecraft:cyan_stained_glass", "minecraft:purple_stained_glass", "minecraft:blue_stained_glass", "minecraft:brown_stained_glass", "minecraft:green_stained_glass", "minecraft:red_stained_glass", "minecraft:black_stained_glass", "minecraft:glass_pane", "minecraft:white_stained_glass_pane", "minecraft:orange_stained_glass_pane", "minecraft:magenta_stained_glass_pane", "minecraft:light_blue_stained_glass_pane", "minecraft:yellow_stained_glass_pane", "minecraft:lime_stained_glass_pane", "minecraft:pink_stained_glass_pane", "minecraft:gray_stained_glass_pane", "minecraft:light_gray_stained_glass_pane", "minecraft:cyan_stained_glass_pane", "minecraft:purple_stained_glass_pane", "minecraft:blue_stained_glass_pane", "minecraft:brown_stained_glass_pane", "minecraft:green_stained_glass_pane", "minecraft:red_stained_glass_pane", "minecraft:black_stained_glass_pane", "minecraft:oak_leaves", "minecraft:spruce_leaves", "minecraft:birch_leaves", "minecraft:jungle_leaves", "minecraft:acacia_leaves", "minecraft:dark_oak_leaves", "minecraft:azalea_leaves", "minecraft:azalea_leaves_flowered", "minecraft:mangrove_leaves", "minecraft:cherry_leaves", "minecraft:azalea", "minecraft:flowering_azalea", "minecraft:oak_fence", "minecraft:spruce_fence", "minecraft:birch_fence", "minecraft:jungle_fence", "minecraft:acacia_fence", "minecraft:dark_oak_fence", "minecraft:mangrove_fence", "minecraft:cherry_fence", "minecraft:crimson_fence", "minecraft:warped_fence", "minecraft:nether_brick_fence", "minecraft:acacia_fence_gate", "minecraft:bamboo_fence_gate", "minecraft:birch_fence_gate", "minecraft:cherry_fence_gate", "minecraft:crimson_fence_gate", "minecraft:dark_oak_fence_gate", "minecraft:fence_gate", "minecraft:jungle_fence_gate", "minecraft:mangrove_fence_gate", "minecraft:pale_oak_fence_gate", "minecraft:spruce_fence_gate", "minecraft:warped_fence_gate", "minecraft:cobblestone_wall", "minecraft:mossy_cobblestone_wall", "minecraft:stone_brick_wall", "minecraft:mossy_stone_brick_wall", "minecraft:granite_wall", "minecraft:diorite_wall", "minecraft:andesite_wall", "minecraft:sandstone_wall", "minecraft:red_sandstone_wall", "minecraft:brick_wall", "minecraft:prismarine_wall", "minecraft:red_nether_brick_wall", "minecraft:end_stone_brick_wall", "minecraft:blackstone_wall", "minecraft:polished_blackstone_wall", "minecraft:polished_blackstone_brick_wall", "minecraft:cobbled_deepslate_wall", "minecraft:polished_deepslate_wall", "minecraft:deepslate_brick_wall", "minecraft:deepslate_tile_wall", "minecraft:tuff_wall", "minecraft:moss_carpet", "minecraft:pale_moss_carpet", "minecraft:pale_hanging_moss", "minecraft:copper_grate", "minecraft:exposed_copper_grate", "minecraft:weathered_copper_grate", "minecraft:oxidized_copper_grate", "minecraft:waxed_copper_grate", "minecraft:waxed_exposed_copper_grate", "minecraft:waxed_weathered_copper_grate", "minecraft:waxed_oxidized_copper_grate", "minecraft:normal_stone_slab", "minecraft:smooth_stone_slab", "minecraft:sandstone_slab", "minecraft:cut_sandstone_slab", "minecraft:stone_slab", "minecraft:brick_slab", "minecraft:stone_brick_slab", "minecraft:nether_brick_slab", "minecraft:quartz_slab", "minecraft:red_sandstone_slab", "minecraft:cut_red_sandstone_slab", "minecraft:purpur_slab", "minecraft:prismarine_slab", "minecraft:prismarine_brick_slab", "minecraft:dark_prismarine_slab", "minecraft:granite_slab", "minecraft:diorite_slab", "minecraft:andesite_slab", "minecraft:mossy_cobblestone_slab", "minecraft:mossy_stone_brick_slab", "minecraft:end_stone_brick_slab", "minecraft:blackstone_slab", "minecraft:polished_blackstone_slab", "minecraft:polished_blackstone_brick_slab", "minecraft:cobbled_deepslate_slab", "minecraft:polished_deepslate_slab", "minecraft:deepslate_brick_slab", "minecraft:deepslate_tile_slab", "minecraft:tuff_slab", "minecraft:oak_slab", "minecraft:spruce_slab", "minecraft:birch_slab", "minecraft:jungle_slab", "minecraft:acacia_slab", "minecraft:dark_oak_slab", "minecraft:mangrove_slab", "minecraft:cherry_slab", "minecraft:crimson_slab", "minecraft:warped_slab", "minecraft:oak_stairs", "minecraft:spruce_stairs", "minecraft:birch_stairs", "minecraft:jungle_stairs", "minecraft:acacia_stairs", "minecraft:dark_oak_stairs", "minecraft:mangrove_stairs", "minecraft:cherry_stairs", "minecraft:crimson_stairs", "minecraft:warped_stairs", "minecraft:normal_stone_stairs", "minecraft:stone_stairs", "minecraft:stone_brick_stairs", "minecraft:brick_stairs", "minecraft:sandstone_stairs", "minecraft:red_sandstone_stairs", "minecraft:quartz_stairs", "minecraft:purpur_stairs", "minecraft:prismarine_stairs", "minecraft:prismarine_brick_stairs", "minecraft:dark_prismarine_stairs", "minecraft:nether_brick_stairs", "minecraft:red_nether_brick_stairs", "minecraft:end_stone_brick_stairs", "minecraft:granite_stairs", "minecraft:polished_granite_stairs", "minecraft:diorite_stairs", "minecraft:polished_diorite_stairs", "minecraft:andesite_stairs", "minecraft:polished_andesite_stairs", "minecraft:mossy_cobblestone_stairs", "minecraft:mossy_stone_brick_stairs", "minecraft:blackstone_stairs", "minecraft:polished_blackstone_stairs", "minecraft:polished_blackstone_brick_stairs", "minecraft:cobbled_deepslate_stairs", "minecraft:polished_deepslate_stairs", "minecraft:deepslate_brick_stairs", "minecraft:deepslate_tile_stairs", "minecraft:tuff_stairs", "minecraft:carpet", "minecraft:white_carpet", "minecraft:orange_carpet", "minecraft:magenta_carpet", "minecraft:light_blue_carpet", "minecraft:yellow_carpet", "minecraft:lime_carpet", "minecraft:pink_carpet", "minecraft:gray_carpet", "minecraft:light_gray_carpet", "minecraft:cyan_carpet", "minecraft:purple_carpet", "minecraft:blue_carpet", "minecraft:brown_carpet", "minecraft:green_carpet", "minecraft:red_carpet", "minecraft:black_carpet", "minecraft:wooden_door", "minecraft:spruce_door", "minecraft:birch_door", "minecraft:jungle_door", "minecraft:acacia_door", "minecraft:dark_oak_door", "minecraft:mangrove_door", "minecraft:cherry_door", "minecraft:crimson_door", "minecraft:warped_door", "minecraft:iron_door", "minecraft:trapdoor", "minecraft:spruce_trapdoor", "minecraft:birch_trapdoor", "minecraft:jungle_trapdoor", "minecraft:acacia_trapdoor", "minecraft:dark_oak_trapdoor", "minecraft:mangrove_trapdoor", "minecraft:cherry_trapdoor", "minecraft:crimson_trapdoor", "minecraft:warped_trapdoor", "minecraft:iron_trapdoor", "minecraft:wooden_button", "minecraft:spruce_button", "minecraft:birch_button", "minecraft:jungle_button", "minecraft:acacia_button", "minecraft:dark_oak_button", "minecraft:mangrove_button", "minecraft:cherry_button", "minecraft:crimson_button", "minecraft:warped_button", "minecraft:stone_button", "minecraft:polished_blackstone_button", "minecraft:wooden_pressure_plate", "minecraft:spruce_pressure_plate", "minecraft:birch_pressure_plate", "minecraft:jungle_pressure_plate", "minecraft:acacia_pressure_plate", "minecraft:dark_oak_pressure_plate", "minecraft:mangrove_pressure_plate", "minecraft:cherry_pressure_plate", "minecraft:crimson_pressure_plate", "minecraft:warped_pressure_plate", "minecraft:stone_pressure_plate", "minecraft:polished_blackstone_pressure_plate", "minecraft:light_weighted_pressure_plate", "minecraft:heavy_weighted_pressure_plate", "minecraft:lever", "minecraft:hopper", "minecraft:heavy_core", "minecraft:lightning_rod", "minecraft:short_grass", "minecraft:tall_grass", "minecraft:fern", "minecraft:large_fern", "minecraft:vine", "minecraft:glow_lichen", "minecraft:cave_vines", "minecraft:sapling", "minecraft:oak_sapling", "minecraft:spruce_sapling", "minecraft:birch_sapling", "minecraft:jungle_sapling", "minecraft:acacia_sapling", "minecraft:dark_oak_sapling", "minecraft:mangrove_propagule", "minecraft:cherry_sapling", "minecraft:dandelion", "minecraft:poppy", "minecraft:blue_orchid", "minecraft:allium", "minecraft:azure_bluet", "minecraft:red_tulip", "minecraft:orange_tulip", "minecraft:white_tulip", "minecraft:pink_tulip", "minecraft:oxeye_daisy", "minecraft:cornflower", "minecraft:lily_of_the_valley", "minecraft:wither_rose", "minecraft:sunflower", "minecraft:lilac", "minecraft:rose_bush", "minecraft:peony", "minecraft:wheat", "minecraft:carrots", "minecraft:potatoes", "minecraft:beetroots", "minecraft:melon_stem", "minecraft:pumpkin_stem", "minecraft:cocoa", "minecraft:nether_wart", "minecraft:bamboo", "minecraft:sugar_cane", "minecraft:kelp", "minecraft:seagrass", "minecraft:sea_pickle", "minecraft:mushroom", "minecraft:red_mushroom", "minecraft:brown_mushroom", "minecraft:flower_pot", "minecraft:decorated_pot", "minecraft:vault", "minecraft:waterlily", "minecraft:bush", "minecraft:dead_bush", "minecraft:firefly_bush", "minecraft:sweet_berry_bush", "minecraft:pointed_dripstone", "minecraft:short_dry_grass", "minecraft:tall_dry_grass", "minecraft:small_dripleaf_block", "minecraft:big_dripleaf", "minecraft:cave_vines_body_with_berries", "minecraft:cave_vines_head_with_berries", "minecraft:leaf_litter", "minecraft:pink_petals", "minecraft:vine", "minecraft:twisting_vines", "minecraft:weeping_vines", "minecraft:nether_sprouts", "minecraft:fire_coral", "minecraft:fire_coral_fan", "minecraft:fire_coral_wall_fan", "minecraft:dead_fire_coral", "minecraft:dead_fire_coral_fan", "minecraft:dead_fire_coral_wall_fan", "minecraft:brain_coral", "minecraft:brain_coral_fan", "minecraft:brain_coral_wall_fan", "minecraft:dead_brain_coral", "minecraft:dead_brain_coral_fan", "minecraft:dead_brain_coral_wall_fan", "minecraft:bubble_coral", "minecraft:bubble_coral_fan", "minecraft:bubble_coral_wall_fan", "minecraft:dead_bubble_coral", "minecraft:dead_bubble_coral_fan", "minecraft:dead_bubble_coral_wall_fan", "minecraft:tube_coral", "minecraft:tube_coral_fan", "minecraft:tube_coral_wall_fan", "minecraft:dead_tube_coral", "minecraft:dead_tube_coral_fan", "minecraft:dead_tube_coral_wall_fan", "minecraft:horn_coral", "minecraft:horn_coral_fan", "minecraft:horn_coral_wall_fan", "minecraft:dead_horn_coral", "minecraft:dead_horn_coral_fan", "minecraft:dead_horn_coral_wall_fan", "minecraft:crimson_roots", "minecraft:warped_roots", "minecraft:pitcher_crop", "minecraft:pitcher_plant", "minecraft:wildflowers", "minecraft:torchflower", "minecraft:orchflower_crop", "minecraft:cactus_flower", "minecraft:open_eyeblossom", "minecraft:closed_eyeblossom", "minecraft:portal", "minecraft:end_portal_frame", "minecraft:chorus_flower", "minecraft:chorus_plant", "minecraft:torch", "minecraft:wall_torch", "minecraft:soul_torch", "minecraft:soul_wall_torch", "minecraft:lantern", "minecraft:soul_lantern", "minecraft:campfire", "minecraft:soul_campfire", "minecraft:candle", "minecraft:white_candle", "minecraft:orange_candle", "minecraft:magenta_candle", "minecraft:light_blue_candle", "minecraft:yellow_candle", "minecraft:lime_candle", "minecraft:pink_candle", "minecraft:gray_candle", "minecraft:light_gray_candle", "minecraft:cyan_candle", "minecraft:purple_candle", "minecraft:blue_candle", "minecraft:brown_candle", "minecraft:green_candle", "minecraft:red_candle", "minecraft:black_candle", "minecraft:brewing_stand", "minecraft:grindstone", "minecraft:enchanting_table", "minecraft:lectern", "minecraft:chest", "minecraft:trapped_chest", "minecraft:ender_chest", "minecraft:redstone_wire", "minecraft:repeater", "minecraft:comparator", "minecraft:rail", "minecraft:powered_rail", "minecraft:detector_rail", "minecraft:activator_rail", "minecraft:bed", "minecraft:ladder", "minecraft:scaffolding", "minecraft:end_rod", "minecraft:bell", "minecraft:chain", "minecraft:iron_bars", "minecraft:tripwire", "minecraft:string", "minecraft:sign", "minecraft:oak_sign", "minecraft:spruce_sign", "minecraft:birch_sign", "minecraft:jungle_sign", "minecraft:acacia_sign", "minecraft:dark_oak_sign", "minecraft:mangrove_sign", "minecraft:cherry_sign", "minecraft:crimson_sign", "minecraft:warped_sign", "minecraft:wall_sign", "minecraft:wall_oak_sign", "minecraft:wall_spruce_sign", "minecraft:wall_birch_sign", "minecraft:wall_jungle_sign", "minecraft:wall_acacia_sign", "minecraft:wall_dark_oak_sign", "minecraft:wall_mangrove_sign", "minecraft:wall_cherry_sign", "minecraft:wall_crimson_sign", "minecraft:wall_warped_sign", "minecraft:painting", "minecraft:item_frame", "minecraft:glow_item_frame", "minecraft:skull", "minecraft:zombie_head", "minecraft:skeleton_skull", "minecraft:wither_skeleton_skull", "minecraft:creeper_head", "minecraft:dragon_head", "minecraft:player_head", "minecraft:barrier", "minecraft:web", "minecraft:anvil", "minecraft:chipped_anvil", "minecraft:damaged_anvil", "minecraft:banner", "minecraft:standing_banner", "minecraft:beacon", "minecraft:conduit", "minecraft:stonecutter_block", "minecraft:dragon_egg", "minecraft:frog_spawn", "minecraft:mob_spawner", "minecraft:trial_spawner", "minecraft:amethyst_cluster", "minecraft:large_amethyst_bud", "minecraft:medium_amethyst_bud", "minecraft:small_amethyst_bud", "minecraft:structure_void", "minecraft:grass_path", "minecraft:farmland"
]);

function stripState(name) {
  return name ? name.split("[")[0] : "";
}

function makeIsSolidBlock() {
  const cache = new Map();
  return function isSolidBlock(name) {
    if (!name) return false;
    if (cache.has(name)) return cache.get(name);

    const base = stripState(name);
    const solid = !NON_SOLID_BLOCKS.has(base);
    cache.set(name, solid);
    return solid;
  };
}
const isSolidBlock = makeIsSolidBlock();

function isHollowBlock(i, getKeyAt, w, h, l) {
  const [x, y, z] = coordsXZY(i, w, h, l);

  if (x <= 0 || y <= 0 || z <= 0 || x >= w - 1 || y >= h - 1 || z >= l - 1) {
    return false;
  }

  if (!isSolidBlock(getKeyAt(indexXZY(x + 1, y, z, w, h, l)))) return false;
  if (!isSolidBlock(getKeyAt(indexXZY(x - 1, y, z, w, h, l)))) return false;
  if (!isSolidBlock(getKeyAt(indexXZY(x, y + 1, z, w, h, l)))) return false;
  if (!isSolidBlock(getKeyAt(indexXZY(x, y - 1, z, w, h, l)))) return false;
  if (!isSolidBlock(getKeyAt(indexXZY(x, y, z + 1, w, h, l)))) return false;
  if (!isSolidBlock(getKeyAt(indexXZY(x, y, z - 1, w, h, l)))) return false;

  return true;
}

function hollowOutSchematic(schem, baseGetKeyAt) {
  const { width: w, height: h, length: l } = schem;
  const volume = w * h * l;
  const hollowMask = new Uint8Array(volume);

  for (let i = 0; i < volume; i++) {
    const k = baseGetKeyAt(i);
    if (!isSolidBlock(k)) continue;
    if (isHollowBlock(i, baseGetKeyAt, w, h, l)) {
      hollowMask[i] = 1;
    }
  }

  return (i) => (hollowMask[i] ? null : baseGetKeyAt(i));
}

export {
  NON_SOLID_BLOCKS,
  stripState,
  isSolidBlock,
  isHollowBlock,
  hollowOutSchematic
};
